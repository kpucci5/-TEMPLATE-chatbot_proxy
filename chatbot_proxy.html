<script>
    document.addEventListener("DOMContentLoaded", function () {
        initPersonalAIChatbot({
	    proxyUrl: "https://your-app.vercel.app/api/proxy",
            initialMessage: "Hi, welcome to our chatbot. How can I help you today?",
            aiAvatarUrl: "{{your_image_url}}",
            userAvatarUrl: "{{your_image_url}}",
            chatbotName: "{{Your Chatbot Name}}",
            sendButtonColor: "#6656FF",
            messageIconColor: "#6656FF",
            startChatButtonColor: "#6656FF",
            userMessageColor: "#d1b8f4",
            initiatorPosition: "bottom-right",
            initialQuestion: "How can I help you today?",
            requireIntake: false,
            defaultUserEmail: "anonymous@user.com",
            intakeFormTitle: "Before we start chatting",
            intakeFormSubtitle: "Please fill out your information to continue",
            webhookUrl: "",
            enableWebhook: false,
            saveHistory: false,
            loadMessageDelay: 300,
            typingSpeed: 15,
            autoResize: true,
            maxInputHeight: 120,
            errorRetryDelay: 3000,
            debounceDelay: 250,
            useLocalCache: true,
            responseTimeout: 45000,
            showTypingIndicator: true,
        });
    });
</script>

<script>
    (function () {
        window.initPersonalAIChatbot = function (config) {
            config = {
                proxyUrl: config.proxyUrl,
                initialMessage: config.initialMessage,
                aiAvatarUrl: config.aiAvatarUrl,
                userAvatarUrl: config.userAvatarUrl,
                chatbotName: config.chatbotName,
                sendButtonColor: config.sendButtonColor || "#6656FF",
                messageIconColor: config.messageIconColor || "#6656FF",
                startChatButtonColor: config.startChatButtonColor || "#6656FF",
                userMessageColor: config.userMessageColor || "#d1b8f4",
                initiatorPosition: config.initiatorPosition || "bottom-right",
                initialQuestion: config.initialQuestion,
                requireIntake:
                    config.requireIntake !== undefined ? config.requireIntake : true,
                defaultUserEmail: config.defaultUserEmail || "anonymous@user.com",
                intakeFormTitle: config.intakeFormTitle || "Before we start chatting",
                intakeFormSubtitle:
                    config.intakeFormSubtitle ||
                    "Please fill out your information to continue",
                webhookUrl: config.webhookUrl,
                enableWebhook:
                    config.enableWebhook !== undefined ? config.enableWebhook : true,
                saveHistory:
                    config.saveHistory !== undefined ? config.saveHistory : true,
                loadMessageDelay: config.loadMessageDelay || 300,
                typingSpeed: config.typingSpeed || 15,
                autoResize: config.autoResize !== undefined ? config.autoResize : true,
                maxInputHeight: config.maxInputHeight || 120,
                errorRetryDelay: config.errorRetryDelay || 3000,
                debounceDelay: config.debounceDelay || 250,
                useLocalCache:
                    config.useLocalCache !== undefined ? config.useLocalCache : true,
                responseTimeout: config.responseTimeout || 15000,
                showTypingIndicator:
                    config.showTypingIndicator !== undefined
                        ? config.showTypingIndicator
                        : true,
            };

            if (!config.proxyUrl) {
                console.error("Proxy URL is required for the chatbot to function");
                return;
            }

            let chatHistory = [];
            let localCache = {};
            let typingTimer;
            let userEmail = null;
            let sessionId = localStorage.getItem("pai-chat-session");
            let initialMessageSent = false;
            let userData = null;
            let isProcessingMessage = false;
            let lastMessageTime = 0;
            let messageQueue = [];
            let controller = null;

            let positionCSS;
            switch (config.initiatorPosition) {
                case "top-left":
                    positionCSS = "top: 20px; left: 20px;";
                    break;
                case "top-right":
                    positionCSS = "top: 20px; right: 20px;";
                    break;
                case "bottom-left":
                    positionCSS = "bottom: 20px; left: 20px;";
                    break;
                case "bottom-right":
                default:
                    positionCSS = "bottom: 20px; right: 20px;";
                    break;
            }

            // Create expanded message icon
            const expandedMessageIcon = document.createElement("div");
            expandedMessageIcon.classList.add(
                "pai-chat-message-icon",
                "expanded",
                "hidden"
            );
            expandedMessageIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" fill="white"/>
            </svg>
        `;
            expandedMessageIcon.style.display = "none";
            document.body.appendChild(expandedMessageIcon);

            const additionalStyles = `
                .pai-chat-message-icon.expanded {
                    position: fixed !important;
                    z-index: 9999 !important;
                    cursor: pointer !important;
                    ${positionCSS}
                    width: 48px !important;
                    height: 48px !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    background-color: ${config.messageIconColor} !important;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.1) !important;
                    border-radius: 50% !important;
                    transform: scale(1) !important;
                    opacity: 1 !important;
                    transition: opacity 0.3s ease, transform 0.3s ease !important;
                }

                .pai-chat-message-icon.expanded svg {
                    width: 24px !important;
                    height: 24px !important;
                    fill: white !important;
                }
                
                .pai-chat-message-icon.expanded.hidden {
                    opacity: 0 !important;
                    transform: scale(0.8) !important;
                    pointer-events: none !important;
                }
            
            .pai-intake-form {
                position: relative;
                background: rgba(255, 255, 255, 0.95);
                padding: 25px 15px;
                border-radius: 15px;
                width: 85%;
                max-width: 320px;
                text-align: center;
                box-shadow: 0 5px 20px rgba(0,0,0,0.1);
                backdrop-filter: blur(10px);
            }

            .pai-intake-form h3 {
                font-size: 15px;
                margin: 0 0 6px 0;
                color: #2B263E;
				padding-bottom: 3px;
            }

            .pai-intake-form h4 {
                font-size: 12px;
                margin: 0 0 6px 0;
                color: #2B263E;
				padding-bottom: 3px;
            }

            
            .pai-intake-form p {
                font-size: 13px;
                margin: 0 0 7px 0;
                color: #666;
            }

            .pai-intake-input {
                width: 100%;
                padding: 8px 12px;
                margin: 8px 0;
                border: 1px solid #EFF0F6;
                border-radius: 8px;
                font-family: 'Inter', sans-serif;
                font-size: 13px;
            }

            .pai-intake-label {
                display: block;
                text-align: left;
                font-size: 12px;
                color: #666;
                margin-top: 8px;
                margin-bottom: 2px;
            }

            .pai-intake-submit {
                background-color: ${config.startChatButtonColor || config.sendButtonColor
                };
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 20px;
                cursor: pointer;
                font-family: 'Inter', sans-serif;
                font-size: 14px;
                transition: opacity 0.3s;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                width: 100%;
                margin-top: 16px;
            }
            
            .pai-intake-submit:hover {
                opacity: 0.9;
            }

            .pai-intake-error {
                color: #FF4444;
                font-size: 12px;
                text-align: left;
                margin-top: 2px;
                display: none;
            }
            
@media (max-width: 480px) {
    .pai-chat-window {
        width: 100% !important;
        height: 100% !important;
        max-height: 100% !important;
        border-radius: 0 !important;
        top: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        left: 0 !important;
        position: fixed !important;
    }
    
    .pai-chat-messages {
        height: calc(100% - 160px) !important;
        padding: 15px !important;
    }
    
    .pai-chat-input-wrapper {
        padding: 10px 15px !important;
    }
    
    .pai-chat-input {
        font-size: 16px !important; /* Prevents zoom on iOS */
        padding: 10px 40px 10px 15px !important;
    }
    
    .pai-chat-message {
        max-width: 90% !important; /* Wider messages on mobile */
    }
    
    .pai-chat-message.user {
        margin-left: 10% !important;
    }
    
    .pai-chat-message.ai {
        margin-right: 10% !important;
    }
    
    .pai-chat-message-content {
        padding: 10px 15px !important;
    }
    
.pai-chat-message-text, .pai-chat-text, .pai-chat-message-content {
  font-family: 'Inter', sans-serif !important;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-size: 14px !important;
  line-height: 1.4 !important;
  font-weight: normal !important;
}
    
    .pai-chat-header {
        padding: 15px 10px !important;
    }
    
    .pai-chat-avatar-header {
        width: 50px !important;
        height: 50px !important;
    }
    
    /* Hide fullscreen toggle on mobile */
    .pai-fullscreen-toggle {
        display: none !important;
    }
    
    /* Make close button bigger on mobile for easier tapping */
    .pai-chat-close {
        font-size: 35px !important;
        padding: 10px !important;
        right: 5px !important;
        top: 5px !important;
    }
    
    /* Ensure the chat bubble doesn't shrink too much on small screens */
    .pai-chat-bubble {
        min-width: 200px !important;
        max-width: 65vw !important;
    }
    
    /* Improved message icon positioning */
    .pai-chat-message-icon.expanded {
        width: 60px !important;
        height: 60px !important;
        bottom: 20px !important;
        right: 20px !important;
    }
    
    .pai-chat-message-icon.expanded svg {
        width: 30px !important;
        height: 30px !important;
    }
    
    /* Better intake form on mobile */
    .pai-intake-form {
        width: 90% !important;
        padding: 25px 20px !important;
        max-width: 350px !important;
    }
    
    .pai-intake-input {
        font-size: 16px !important; /* Prevents zoom on iOS */
        padding: 12px !important;
    }
    
    .pai-intake-submit {
        padding: 14px 20px !important;
        font-size: 16px !important;
    }
    
    /* Style adjustments to ensure content is visible */
    .pai-chat-footer {
        padding: 5px 15px !important;
    }
}

            /* Improve the loading animation */
            @keyframes bounce {
                0%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-5px); }
            }

            .pai-chat-typing-indicator span {
                animation: bounce 1s infinite ease-in-out;
            }

            /* Add loading spinner */
            .pai-loading-spinner {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid rgba(0,0,0,0.1);
                border-radius: 50%;
                border-top-color: ${config.sendButtonColor};
                animation: spin 1s infinite linear;
                margin-right: 5px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Smooth transitions for better UX */
            .pai-chat-message {
                opacity: 0;
                transform: translateY(10px);
                animation: fadeInUp 0.3s forwards;
            }

            @keyframes fadeInUp {
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;

            const styleSheet = document.createElement("style");
            styleSheet.textContent = additionalStyles;
            document.head.appendChild(styleSheet);

            const style = document.createElement("style");
            style.textContent = `
            @import url('https://fonts.googleapis.com/css?family=Inter');

            #personal-ai-chat-widget {
                font-family: "Inter", sans-serif !important;
            }

            .pai-chat-initiator {
                position: fixed;
                display: flex;
                align-items: flex-start;
                z-index: 1000;
                cursor: pointer;
                transition: opacity 0.3s ease;
                ${positionCSS}
            }

            .pai-chat-avatar-wrapper {
                margin-right: 10px;
            }

            .pai-chat-avatar-wrapper,
            .pai-chat-bubble {
                transition: opacity 0.3s ease;
            }

            .pai-chat-avatar {
                width: 60px;
                height: 60px;
                border-radius: 15px 0px 15px 15px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .pai-chat-bubble-wrapper {
                position: relative;
                cursor: pointer;
            }

            .pai-chat-bubble {
                background-color: #fff;
                border: 1px solid #EFF0F6;
                border-radius: 0 15px 15px 15px;
                padding: 10px 15px 15px 15px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.075);
                max-width: 300px;
                cursor: pointer;
            }

            .pai-chat-text {
                font-size: 14px;
                line-height: 1.4;
                min-height: 50px;
                display: flex;
                align-items: center;
            }

            .pai-chat-message-icon {
                    position: absolute;
                    bottom: -8px;
                    right: -8px;
                    width: 24px;
                    height: 24px;
                    opacity: 0;
                    transition: all 0.5s ease-in-out;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1001;
                    background-color: ${config.messageIconColor};
                    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            }
    

            .pai-chat-message-icon.fade-in {
                opacity: 1;
            }

            .pai-chat-message-icon svg {
                    fill: white;
                    width: 12px;
                    height: 12px;
            }

            .pai-chat-initiator-close {
                    position: absolute;
                    right: -8px;
                    top: -8px;
                    background: white;
                    border: none;
                    width: 24px;
                    height: 24px;
                    cursor: pointer;
                    color: #2B263E;
                    z-index: 1003;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    transition: opacity 0.5s ease-in-out;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                    font-size: 18px;
            }

            .pai-chat-initiator-close.fade-in {
                opacity: 1;
            }

            .pai-chat-window {
                display: none;
                position: fixed;
                ${positionCSS}
                width: 380px;
                height: 600px;
                background-color: white;
                border-radius: 20px;
                box-shadow: 0 5px 40px rgba(0,0,0,0.16);
                flex-direction: column;
                z-index: 1002;
                overflow: hidden;
                transition: all 0.3s ease-in-out;
                max-height: calc(100vh - 100px);
            }

            .pai-chat-window.fullscreen {
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 80% !important;
                height: 80vh !important;
                max-width: 1200px;
            }

            .pai-email-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(3px);
                z-index: 1003;
                display: none;
                justify-content: center;
                align-items: center;
                border-radius: 20px;
            }

            .pai-chat-header {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px 10px;
                border-bottom: 1px solid #EFF0F6;
                position: relative;
            }

            .pai-chat-header-content {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .pai-chat-avatar-header {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                margin-bottom: 10px;
            }

            .pai-chat-title {
                font-size: 16px;
                font-weight: bold;
                color: #2B263E;
            }

            .pai-chat-close {
                position: absolute;
                right: 10px;
                top: 10px;
                background: none;
                border: none;
                font-size: 30px;
                cursor: pointer;
                color: #2B263E;
            }

            .pai-fullscreen-toggle {
                position: absolute;
                right: 45px;
                top: 10px;
                background: none;
                border: none;
                cursor: pointer;
                padding: 8px;
                color: #2B263E;
                opacity: 0.7;
                transition: opacity 0.3s;
                line-height: 0;
                display: flex;
                align-items: center;
            }

            .pai-fullscreen-toggle:hover {
                opacity: 1;
            }

            .pai-fullscreen-toggle svg {
                width: 20px;
                height: 20px;
            }

            .pai-chat-messages {
                flex: 1 1 auto;
                overflow-y: auto;
                padding: 10px;
                background-color: #F8F9FD;
                scrollbar-width: thin;
                scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
                height: calc(100% - 180px);
                min-height: 200px;
                display: flex;
                flex-direction: column;
            }

            .pai-chat-messages::-webkit-scrollbar {
                width: 6px;
            }

            .pai-chat-messages::-webkit-scrollbar-track {
                background: transparent;
            }

            .pai-chat-messages::-webkit-scrollbar-thumb {
                background-color: rgba(0, 0, 0, 0.2);
                border-radius: 3px;
            }

            .pai-chat-message {
                display: flex;
                align-items: flex-start;
                margin-bottom: 15px;
                max-width: 80%;
                flex-shrink: 0;
            }

            .pai-chat-message.ai {
                align-self: flex-start;
                margin-right: 10%;
            }

            .pai-chat-message.user {
                align-self: flex-end;
                margin-left: 25%;
                position: relative;
                padding-right: 2px;
                flex-direction: row-reverse; /* This flips the order of elements */
            }
            
            .pai-chat-message-avatar {
                width: 40px;
                height: 40px;
                border-radius: 10px 0px 10px 10px;
                margin: 0 8px;
                flex-shrink: 0;
            }

            .pai-chat-message-content {
                background-color: #fff;
                border-radius: 15px;
                padding: 8px 12px;
                max-width: calc(100% - 46px);
                position: relative;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                word-break: break-word;
            }

            .pai-chat-message.ai .pai-chat-message-content {
                border-top-left-radius: 0;
            }

            .pai-chat-message.user .pai-chat-message-avatar {
                border-radius: 0px 10px 10px 10px;
                margin: 0 0 0 8px; /* Keep the left margin we set earlier */
            }

            .pai-chat-message.user .pai-chat-message-content {
                border-radius: 12px 0px 12px 12px; /* Update border radius to match the new orientation */
                background-color: ${config.sendButtonColor};
                color: white;
            }


            .pai-chat-message-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 4px;
            }

            .pai-chat-message-name {
                font-size: 12px;
                font-weight: bold;
                color: #666;
            }

            .pai-chat-message.user .pai-chat-message-name,
            .pai-chat-message.user .pai-chat-message-time {
                color: rgba(255,255,255,0.8);
            }

            .pai-chat-message-time {
                font-size: 10px;
                margin-left: 5px;
                color: #888;
            }

.pai-chat-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    padding: 10px;
    min-height: 60px;
    background: #fff;
    border-top: 1px solid #EFF0F6;
    margin-top: auto;
    width: 100%; /* Ensure full width */
    box-sizing: border-box; /* Include padding in width calculation */
}

.pai-chat-input {
    width: 100%;
    max-width: 100%;
    border: none;
    background: transparent;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    line-height: 1.4;
    color: #000000;
    outline: none;
    resize: none;
    overflow-y: auto; /* Always use auto overflow */
    overflow-x: hidden;
    padding: 12px 45px 12px 12px;
    height: 50px;
    min-height: 50px;
    max-height: 60px; /* Make all height properties the same */
    border: 1px solid #EFF0F6;
    border-radius: 20px;
    box-sizing: border-box;
    word-wrap: break-word;
    word-break: break-word;
    white-space: pre-wrap;
}

/* Improve scrollbar appearance */
.pai-chat-input::-webkit-scrollbar {
    width: 6px;
        opacity: 0;
    transition: opacity 0.3s ease;
}

.pai-chat-input::-webkit-scrollbar-track {
    background: transparent;
}

.pai-chat-input::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
        opacity: 0;
    transition: opacity 0.3s ease;
}

.pai-chat-input:hover::-webkit-scrollbar-thumb,
.pai-chat-input:focus::-webkit-scrollbar-thumb {
    opacity: 1;
}

/* For Firefox */
.pai-chat-input {
    scrollbar-color: transparent transparent;
}

.pai-chat-input:hover,
.pai-chat-input:focus {
    scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

            .pai-chat-input:disabled,
            .pai-chat-send-inline:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .pai-chat-send-inline {
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                cursor: pointer;
                padding: 5px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .pai-chat-send-inline svg {
                width: 20px;
                height: 20px;
                fill: ${config.sendButtonColor};
            }

            .pai-chat-input::placeholder {
                color: #CCCCCC;
                opacity: 1;
            }

            .pai-chat-footer {
                display: flex;
                justify-content: flex-start;
                align-items: center;
                padding: 2px 15px;
                background-color: white;
                border-top: 1px solid #EFF0F6;
            }

            .pai-powered-by {
                font-size: 11px;
                color: #888;
                display: flex;
                align-items: center;
            }

            .pai-powered-by a {
                display: flex;
                align-items: center;
                text-decoration: none;
            }

            .pai-powered-by-logo {
  opacity: 1 !important;
  visibility: visible !important;
  display: block !important;
  position: relative !important;
  height: auto !important;
  width: auto !important;
  max-width: 110px !important;
  padding: 0 !important;
  margin: 5px !important;
}

            .pai-chat-typing-indicator {
                display: inline-flex;
                align-items: center;
                padding: 10px 0;
                  transform: translateZ(0);
  backface-visibility: hidden;
            }

            .pai-chat-typing-indicator span {
                height: 8px;
                width: 8px;
                background-color: ${config.sendButtonColor};
                border-radius: 50%;
                display: inline-block;
                margin-right: 5px;
                animation: typing .5s infinite ease-in-out;
            }

            .pai-chat-typing-indicator span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .pai-chat-typing-indicator span:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes typing {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-5px); }
                100% { transform: translateY(0px); }
            }

            @media (max-width: 480px) {
                .pai-chat-window {
                    width: 100% !important;
                    height: 100% !important;
                    max-height: 100% !important;
                    border-radius: 0 !important;
                    top: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    left: 0 !important;

  }

                
                .pai-chat-messages {
                    height: calc(100% - 160px) !important;
                }
                
                .pai-chat-input-wrapper {
                    padding: 8px !important;
                }

                  .pai-chat-message-content {
    /* Prevent text blurriness during animations */
    transform: translateZ(0);
    text-rendering: optimizeLegibility;
  }
            }
        `;
            document.head.appendChild(style);

            const chatWidgetHtml = `
            <div id="personal-ai-chat-widget" class="pai-chat-closed">
                <div class="pai-chat-initiator">
                    <div class="pai-chat-avatar-wrapper">
                        <img src="${config.aiAvatarUrl
                }" alt="AI Avatar" class="pai-chat-avatar">
                    </div>
                    <div class="pai-chat-bubble-wrapper">
                        <div class="pai-chat-bubble">
                            <span class="pai-chat-text" id="ai-initial-message"></span>
                        </div>
                        <div class="pai-chat-message-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                            </svg>
                        </div>
                        <button class="pai-chat-initiator-close">&times;</button>
                    </div>
                </div>
                <div class="pai-chat-window">
                    <div class="pai-email-overlay" style="${!config.requireIntake ? "display: none !important;" : ""
                }">
                        <div class="pai-intake-form">
                            <button class="pai-chat-close">&times;</button>
                            <h3>${config.intakeFormTitle}</h3>
                            <p>${config.intakeFormSubtitle}</p>
                            <br>
                            <div>
                                <label class="pai-intake-label" for="firstName">First Name*</label>
                                <input type="text" id="firstName" class="pai-intake-input" placeholder="Enter your first name">
                                <div class="pai-intake-error" id="firstName-error">Please enter your first name</div>
                            </div>
                            <div>
                                <label class="pai-intake-label" for="lastName">Last Name*</label>
                                <input type="text" id="lastName" class="pai-intake-input" placeholder="Enter your last name">
                                <div class="pai-intake-error" id="lastName-error">Please enter your last name</div>
                            </div>
                            <div>
                                <label class="pai-intake-label" for="email">Email Address*</label>
                                <input type="email" id="email" class="pai-intake-input" placeholder="Enter your email address">
                                <div class="pai-intake-error" id="email-error">Please enter a valid email address</div>
                            </div>
                            <div>
                                <label class="pai-intake-label" for="phone">Phone Number (optional)</label>
                                <input type="tel" id="phone" class="pai-intake-input" placeholder="Enter your phone number">
                                <div class="pai-intake-error" id="phone-error">Please enter a valid phone number</div>
                            </div>
                            <button class="pai-intake-submit">Start Chat</button>
                        </div>
                    </div>
                    <div class="pai-chat-header">
                        <div class="pai-chat-header-content">
                            <img src="${config.aiAvatarUrl
                }" alt="AI Avatar" class="pai-chat-avatar-header">
                            <span class="pai-chat-title">Chat with ${config.chatbotName
                }</span>
                        </div>
                        <button class="pai-fullscreen-toggle">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                            </svg>
                        </button>
                        <button class="pai-chat-close">&times;</button>
                    </div>
                    <div class="pai-chat-messages"></div>
                    <div class="pai-chat-input-wrapper">
                        <textarea class="pai-chat-input" rows="1" placeholder="Type your message..." disabled></textarea>
                        <button class="pai-chat-send-inline" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="pai-chat-footer">
                        <div class="pai-powered-by">
                            <a href="https://www.personal.ai" target="_blank">
                                <img src="https://img.pai-l.ink/eb6b274fd53b45eebb523f98ab96b1f1" alt="Personal.ai" class="pai-powered-by-logo">
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
            document.body.insertAdjacentHTML("beforeend", chatWidgetHtml);

            const chatWidget = document.getElementById("personal-ai-chat-widget");
            const chatInitiator = chatWidget.querySelector(".pai-chat-initiator");
            const chatWindow = chatWidget.querySelector(".pai-chat-window");
            const emailOverlay = chatWidget.querySelector(".pai-email-overlay");
            const intakeForm = chatWidget.querySelector(".pai-intake-form");
            const messageIcon = chatWidget.querySelector(".pai-chat-message-icon");
            const initiatorCloseButton = chatWidget.querySelector(
                ".pai-chat-initiator-close"
            );
            const mainChatClose = chatWindow.querySelector(
                ".pai-chat-header .pai-chat-close"
            );
            const emailFormClose = emailOverlay.querySelector(".pai-chat-close");
            const fullscreenToggle = chatWidget.querySelector(
                ".pai-fullscreen-toggle"
            );
            const chatMessages = chatWidget.querySelector(".pai-chat-messages");
            const chatInput = chatWidget.querySelector(".pai-chat-input");
            const sendButton = chatWidget.querySelector(".pai-chat-send-inline");
            const aiInitialMessage = document.getElementById("ai-initial-message");

            // Intake form elements
            const inputs = {
                firstName: intakeForm.querySelector("#firstName"),
                lastName: intakeForm.querySelector("#lastName"),
                email: intakeForm.querySelector("#email"),
                phone: intakeForm.querySelector("#phone"),
            };
            const errors = {
                firstName: intakeForm.querySelector("#firstName-error"),
                lastName: intakeForm.querySelector("#lastName-error"),
                email: intakeForm.querySelector("#email-error"),
                phone: intakeForm.querySelector("#phone-error"),
            };
            const submitButton = intakeForm.querySelector(".pai-intake-submit");

            // Check for existing session or set default if intake not required
            if (sessionId) {
                userEmail = sessionId;
                chatInput.disabled = false;
                sendButton.disabled = false;
                emailOverlay.style.display = "none";

                // Load chat history if enabled
                if (config.saveHistory) {
                    try {
                        chatHistory = loadChatHistory();

                        // Display chat history immediately for a return visitor
                        if (chatHistory.length > 0) {
                            // We need to delay this slightly to ensure the chat interface is ready
                            setTimeout(() => {
                                displayChatHistory();
                                initialMessageSent = true; // Mark as sent so we don't show welcome again
                            }, 100);
                        }
                    } catch (e) {
                        console.error("Error loading chat history:", e);
                    }
                }
            } else if (!config.requireIntake) {
                userEmail = config.defaultUserEmail;
                sessionId = config.defaultUserEmail;
                localStorage.setItem("pai-chat-session", config.defaultUserEmail);
                chatInput.disabled = false;
                sendButton.disabled = false;
                emailOverlay.style.display = "none";

                // Load chat history if enabled
                if (config.saveHistory) {
                    try {
                        chatHistory = loadChatHistory();

                        // Display chat history immediately for a return visitor
                        if (chatHistory.length > 0) {
                            setTimeout(() => {
                                displayChatHistory();
                                initialMessageSent = true;
                            }, 100);
                        }
                    } catch (e) {
                        console.error("Error loading chat history:", e);
                    }
                }
            }

            function showMessageIcon() {
                chatInitiator.style.display = "none";
                chatWindow.style.display = "none";

                // First show the icon (still with hidden class)
                expandedMessageIcon.style.display = "flex";

                // Small delay to allow display:flex to take effect before removing the hidden class
                setTimeout(() => {
                    expandedMessageIcon.classList.remove("hidden");
                }, 10);
            }

            function validateInput(input, errorElement, validationFn) {
                const value = input.value.trim();
                const isValid = validationFn(value);
                errorElement.style.display = isValid ? "none" : "block";
                return isValid;
            }

            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            function isValidPhone(phone) {
                // If empty, consider valid (since it's optional)
                if (phone.trim() === "") return true;

                return /^\+?\d{10,}$/.test(phone.replace(/[\s()-]/g, ""));
            }

            function getCurrentTime() {
                const now = new Date();
                return now.toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                });
            }

            // Debounced resize function for better performance
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Functions to manage chat history with error handling
            function saveChatHistory() {
                if (!config.saveHistory || !userEmail) return;

                try {
                    // Limit history to last 50 messages to prevent localStorage overflow
                    if (chatHistory.length > 50) {
                        chatHistory = chatHistory.slice(chatHistory.length - 50);
                    }

                    // Create a storage key based on user email
                    const storageKey = `pai-chat-history-${userEmail}`;
                    localStorage.setItem(storageKey, JSON.stringify(chatHistory));
                } catch (e) {
                    console.error("Error saving chat history:", e);
                }
            }

            function loadChatHistory() {
                if (!config.saveHistory || !userEmail) return [];

                try {
                    // Get history from localStorage
                    const storageKey = `pai-chat-history-${userEmail}`;
                    const savedHistory = localStorage.getItem(storageKey);

                    if (savedHistory) {
                        return JSON.parse(savedHistory);
                    }
                } catch (e) {
                    console.error("Error loading chat history:", e);
                }

                return [];
            }

            function clearChatHistory() {
                chatHistory = [];
                if (config.saveHistory && userEmail) {
                    try {
                        const storageKey = `pai-chat-history-${userEmail}`;
                        localStorage.removeItem(storageKey);
                    } catch (e) {
                        console.error("Error clearing chat history:", e);
                    }
                }
            }

            function displayChatHistory() {
                if (!config.saveHistory || !chatHistory || chatHistory.length === 0) {
                    return;
                }

                // Clear the chat area first
                chatMessages.innerHTML = "";

                // Display each message from history in batches for better performance
                const batchSize = 5;
                const totalMessages = chatHistory.length;

                function displayBatch(startIndex) {
                    const endIndex = Math.min(startIndex + batchSize, totalMessages);

                    for (let i = startIndex; i < endIndex; i++) {
                        const msg = chatHistory[i];
                        if (msg.type === "user") {
                            displayUserMessage(msg.content, msg.time, false);
                        } else if (msg.type === "ai") {
                            displayAIMessage(msg.content, msg.time, false);
                        }
                    }

                    if (endIndex < totalMessages) {
                        setTimeout(() => displayBatch(endIndex), config.loadMessageDelay);
                    } else {
                        // After all messages are displayed, scroll to bottom
                        scrollToBottom();
                    }
                }

                // Start displaying messages in batches
                displayBatch(0);

                // Mark initial message as sent to prevent duplicates
                initialMessageSent = true;
            }

            function displayUserMessage(
                message,
                time = getCurrentTime(),
                addToHistory = true
            ) {
                const messageElement = document.createElement("div");
                messageElement.classList.add("pai-chat-message", "user");

                messageElement.innerHTML = `
                    <img src="${config.userAvatarUrl}" alt="User Avatar" class="pai-chat-message-avatar">
                    <div class="pai-chat-message-content">
                        <div class="pai-chat-message-header">
                            <span class="pai-chat-message-name">You</span>
                            <span class="pai-chat-message-time">${time}</span>
                        </div>
                        <div class="pai-chat-message-text">${message}</div>
                    </div>
                `;

                chatMessages.appendChild(messageElement);

                // Add to chat history if needed
                if (addToHistory && config.saveHistory) {
                    chatHistory.push({
                        type: "user",
                        content: message,
                        time: time,
                    });
                    saveChatHistory();
                }
            }

            function displayAIMessage(
                message,
                time = getCurrentTime(),
                addToHistory = true
            ) {
                const messageElement = document.createElement("div");
                messageElement.classList.add("pai-chat-message", "ai");

                messageElement.innerHTML = `
                    <img src="${config.aiAvatarUrl}" alt="AI Avatar" class="pai-chat-message-avatar">
                    <div class="pai-chat-message-content">
                        <div class="pai-chat-message-header">
                            <span class="pai-chat-message-name">${config.chatbotName}</span>
                            <span class="pai-chat-message-time">${time}</span>
                        </div>
                        <div class="pai-chat-message-text">${message}</div>
                    </div>
                `;

                chatMessages.appendChild(messageElement);

                // Add to chat history if needed
                if (addToHistory && config.saveHistory) {
                    chatHistory.push({
                        type: "ai",
                        content: message,
                        time: time,
                    });
                    saveChatHistory();
                }
            }

            // Animation function for more natural typing of initial message
            function typeMessage(targetElement, message, callback, customSpeed) {
                let index = 0;
                targetElement.textContent = "";
                const speed = customSpeed || config.typingSpeed;

                function typeChar() {
                    if (index < message.length) {
                        targetElement.textContent += message.charAt(index);
                        index++;
                        // Vary typing speed slightly for more natural effect
                        const randomDelay = speed * (0.5 + Math.random());
                        setTimeout(typeChar, randomDelay);
                    } else {
                        if (callback) callback();
                    }
                }

                typeChar();
            }

            function typeInitialMessage() {
                const isMobile = window.innerWidth <= 480;
                const typingSpeed = isMobile
                    ? Math.max(config.typingSpeed, 25)
                    : config.typingSpeed;

                typeMessage(
                    aiInitialMessage,
                    config.initialMessage,
                    function () {
                        messageIcon.classList.add("fade-in");
                        initiatorCloseButton.classList.add("fade-in");
                    },
                    typingSpeed
                );
            }

            function scrollToBottom() {
                requestAnimationFrame(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }

            // Process message with better formatting and link detection
            function formatMessage(text) {
                const containsHTML = /<[a-z][\s\S]*>/i.test(text);

                if (containsHTML) {
                    text = text.replace(/\n(?![^<]*>)/g, "<br>");

                    text = text.replace(
                        /<a\s+(?![^>]*target=)[^>]*href=["']([^"']+)["'][^>]*>/gi,
                        function (match, url) {
                            return match.replace(
                                />$/,
                                ' target="_blank" rel="noopener noreferrer">'
                            );
                        }
                    );

                    return text;
                }

                text = text.replace(/\r\n/g, "\n");

                const urlRegex =
                    /(https?:\/\/[^\s\)\]\.,:;"']+(?:\.[^\s\)\]\.,:;"']+)+(?:\/[^\s\)\]\.,:;"']*)*)/g;

                text = text.replace(urlRegex, function (url) {
                    const cleanUrl = url.replace(/[.,;:!?]$/, "");
                    return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer">${cleanUrl}</a>`;
                });

                text = text.replace(
                    /(?<=^|\s)(www\.[^\s\)\]\.,:;"']+(?:\.[^\s\)\]\.,:;"']+)+(?:\/[^\s\)\]\.,:;"']*)*)/g,
                    function (url) {
                        const cleanUrl = url.replace(/[.,;:!?]$/, "");
                        return `<a href="https://${cleanUrl}" target="_blank" rel="noopener noreferrer">${cleanUrl}</a>`;
                    }
                );

                const bulletPatterns = [
                    { pattern: /^•\s+/m, type: "bullet" },
                    { pattern: /^-\s+/m, type: "dash" },
                    { pattern: /^\*\s+/m, type: "asterisk" },
                    { pattern: /^×\s+/m, type: "times" },
                    { pattern: /^·\s+/m, type: "middot" },
                    { pattern: /^○\s+/m, type: "circle" },
                    { pattern: /^■\s+/m, type: "square" },
                    { pattern: /^➤\s+/m, type: "arrow" },
                    { pattern: /^✓\s+/m, type: "check" },
                    { pattern: /^\d+\.\s+/m, type: "numbered" },
                ];

                const hasBullets = bulletPatterns.some((bp) => bp.pattern.test(text));

                if (hasBullets) {
                    let lines = text.split("\n");
                    let processedLines = [];
                    let currentList = null;

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) {
                            if (currentList) {
                                processedLines.push(currentList === "ol" ? "</ol>" : "</ul>");
                                currentList = null;
                            }
                            processedLines.push("");
                            continue;
                        }

                        let matched = false;

                        for (const bp of bulletPatterns) {
                            if (bp.type !== "numbered" && line.match(bp.pattern)) {
                                if (currentList !== "ul") {
                                    if (currentList) {
                                        processedLines.push(
                                            currentList === "ol" ? "</ol>" : "</ul>"
                                        );
                                    }
                                    processedLines.push("<ul>");
                                    currentList = "ul";
                                }

                                processedLines.push(
                                    "<li>" + line.replace(bp.pattern, "") + "</li>"
                                );
                                matched = true;
                                break;
                            }
                        }

                        if (!matched && /^\d+\.\s+/.test(line)) {
                            if (currentList !== "ol") {
                                if (currentList) {
                                    processedLines.push(currentList === "ol" ? "</ol>" : "</ul>");
                                }
                                processedLines.push("<ol>");
                                currentList = "ol";
                            }

                            processedLines.push(
                                "<li>" + line.replace(/^\d+\.\s+/, "") + "</li>"
                            );
                            matched = true;
                        }

                        if (!matched) {
                            if (currentList) {
                                processedLines.push(currentList === "ol" ? "</ol>" : "</ul>");
                                currentList = null;
                            }

                            processedLines.push(line);
                        }
                    }

                    if (currentList) {
                        processedLines.push(currentList === "ol" ? "</ol>" : "</ul>");
                    }

                    text = processedLines.join("\n");
                }

                text = text.replace(/\n\s*\n/g, "</p><p>");

                if (!text.startsWith("<")) {
                    text = "<p>" + text;
                }
                if (!text.endsWith(">")) {
                    text = text + "</p>";
                }

                text = text.replace(/\n/g, "<br>");

                return text;
            }

            // Better error handling for API calls
            async function fetchWithTimeout(url, options, timeout) {
                controller = new AbortController();
                const signal = controller.signal;

                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        controller.abort();
                        reject(new Error("Request timeout"));
                    }, timeout);
                });

                return Promise.race([
                    fetch(url, { ...options, signal }),
                    timeoutPromise,
                ]);
            }

            // Optimized message handling with rate limiting and queue
            async function handleMessage(message) {
                if (!message.trim() || isProcessingMessage) return;

                // Check rate limiting
                const now = Date.now();
                if (now - lastMessageTime < 500) {
                    messageQueue.push(message);
                    return;
                }

                isProcessingMessage = true;
                lastMessageTime = now;

                // Abort any existing request before starting a new one
                if (controller) {
                    try {
                        controller.abort();
                    } catch (e) {
                        console.warn("Error aborting previous request:", e);
                    }
                }

                try {
                    // Local cache check
                    if (config.useLocalCache && localCache[message.trim()]) {
                        displayUserMessage(message);
                        chatInput.value = "";
                        resizeInput();

                        const cachedResponse = localCache[message.trim()];
                        const aiMessageElement = createTypingIndicator();

                        setTimeout(() => {
                            displayAIMessage(formatMessage(cachedResponse));
                            chatMessages.removeChild(aiMessageElement);
                            scrollToBottom();
                        }, 500);

                        isProcessingMessage = false;

                        if (messageQueue.length > 0) {
                            const nextMessage = messageQueue.shift();
                            setTimeout(() => handleMessage(nextMessage), 100);
                        }

                        return;
                    }

                    displayUserMessage(message);
                    chatInput.value = "";
                    resizeInput();

                    const aiMessageElement = createTypingIndicator();

                    // Create new controller for this request
                    controller = new AbortController();
                    const signal = controller.signal;

                    try {
                        const response = await fetch(config.proxyUrl, {

                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                Text: message,
                                UserName: userEmail,
                                SourceName: "WebChat",
                                SessionId: userEmail,
                                is_draft: false,
                            }),
                            signal: signal,
                        }
                        );

                        if (!response.ok) {
                            throw new Error(
                                `API Error: ${response.status} ${response.statusText}`
                            );
                        }

                        // Process the streaming response
                        const streamProcessor = await streamResponse(response);
                        const responseText = await streamProcessor.processMessage(
                            aiMessageElement
                        );

                        // Cache the response
                        if (config.useLocalCache && responseText) {
                            localCache[message.trim()] = responseText;

                            // Limit cache size
                            const cacheKeys = Object.keys(localCache);
                            if (cacheKeys.length > 20) {
                                delete localCache[cacheKeys[0]];
                            }
                        }
                    } catch (error) {
                        console.error("API or Processing Error:", error);

                        // Remove typing indicator if it exists
                        if (aiMessageElement && aiMessageElement.parentNode) {
                            chatMessages
                                .querySelector(".pai-chat-typing-indicator")
                                ?.parentNode?.parentNode.remove();
                        }

                        // Show appropriate error message
                        if (error.name === "AbortError") {
                            // This error means the request was canceled intentionally (which is fine)
                            console.log("Request was aborted intentionally");
                        } else if (!navigator.onLine) {
                            displayAIMessage(
                                "It looks like you're offline. Please check your internet connection and try again."
                            );
                        } else {
                            displayAIMessage(
                                "I'm sorry, but I'm having trouble responding right now. Please try again in a moment."
                            );
                        }
                    }
                } finally {
                    isProcessingMessage = false;

                    // Process next message in queue if any
                    if (messageQueue.length > 0) {
                        const nextMessage = messageQueue.shift();
                        setTimeout(() => handleMessage(nextMessage), 500);
                    }
                }
            }

            function createTypingIndicator() {
                const aiMessageElement = document.createElement("div");
                aiMessageElement.classList.add("pai-chat-message", "ai");
                const time = getCurrentTime();

                aiMessageElement.innerHTML = `
                    <img src="${config.aiAvatarUrl}" alt="AI Avatar" class="pai-chat-message-avatar">
                    <div class="pai-chat-message-content">
                        <div class="pai-chat-message-header">
                            <span class="pai-chat-message-name">${config.chatbotName}</span>
                            <span class="pai-chat-message-time">${time}</span>
                        </div>
                        <div class="pai-chat-message-text">
                            <div class="pai-chat-typing-indicator">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                `;

                chatMessages.appendChild(aiMessageElement);
                scrollToBottom();

                return aiMessageElement;
            }

            // Improved streaming response handling
            // Stream response handler with proper AbortError handling
            async function streamResponse(response) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";
                let accumulatedMessage = "";
                let seenEmptyMessage = false;
                let isActiveRequest = true; // Flag to track if this request is still active

                // This function should be called when the chat is closed or a new message is sent
                // Currently not used directly in this snippet but would be connected to the controller
                function cancelRequest() {
                    isActiveRequest = false;
                    try {
                        if (reader && typeof reader.cancel === "function") {
                            reader.cancel();
                        }
                    } catch (e) {
                        console.error("Error canceling reader:", e);
                    }
                }

                return {
                    async processMessage(messageDiv) {
                        const contentDiv = messageDiv.querySelector(
                            ".pai-chat-message-text"
                        );

                        try {
                            contentDiv.style.width = "auto";

                            // Reset controller for next request
                            controller = new AbortController();

                            // Reading loop
                            while (isActiveRequest) {
                                try {
                                    const { done, value } = await reader.read();
                                    if (done) break;

                                    buffer += decoder.decode(value, { stream: true });
                                    const lines = buffer.split("\n");
                                    buffer = lines.pop() || "";

                                    for (const line of lines) {
                                        if (!line.startsWith("data: ")) continue;

                                        try {
                                            const data = JSON.parse(line.slice(6));

                                            if (
                                                !data ||
                                                data.ai_message === null ||
                                                data.ai_message === undefined
                                            )
                                                continue;

                                            if (data.ai_message === "") {
                                                if (accumulatedMessage.length > 0) {
                                                    seenEmptyMessage = true;
                                                }
                                                continue;
                                            }

                                            if (
                                                seenEmptyMessage &&
                                                data.ai_message &&
                                                data.ai_message.length > accumulatedMessage.length * 0.9
                                            ) {
                                                continue;
                                            }

                                            if (data.ai_message) {
                                                let cleanMessage = data.ai_message;

                                                if (
                                                    typeof cleanMessage === "string" &&
                                                    cleanMessage.startsWith(`${config.chatbotName}:`)
                                                ) {
                                                    cleanMessage = cleanMessage
                                                        .split(`${config.chatbotName}:`)[1]
                                                        .replace(/^\s+|\s+$/g, "")
                                                        .replace(/^[\s\uFEFF\xA0]+/, "")
                                                        .trimLeft();
                                                }

                                                accumulatedMessage += cleanMessage;

                                                // Use a try/catch specifically for updating the UI
                                                try {
                                                    if (contentDiv) {
                                                        contentDiv.innerHTML =
                                                            formatMessage(accumulatedMessage);
                                                        scrollToBottom();
                                                    }
                                                } catch (uiError) {
                                                    console.error("UI update error:", uiError);
                                                }
                                            }
                                        } catch (parseError) {
                                            console.error("JSON parse error:", parseError);
                                        }
                                    }
                                } catch (streamError) {
                                    console.warn("Stream read interrupted:", streamError);

                                    // For AbortError, just stop and return what we have
                                    if (streamError.name === "AbortError") {
                                        console.log(
                                            "Request was aborted, returning accumulated message"
                                        );
                                        break;
                                    }

                                    // For other errors, try to continue but add a delay to avoid thrashing
                                    await new Promise((resolve) => setTimeout(resolve, 100));

                                    // If we've had multiple errors, eventually give up
                                    if (!accumulatedMessage) {
                                        throw streamError;
                                    }

                                    break;
                                }
                            }

                            // Process any remaining buffer
                            if (buffer && buffer.startsWith("data: ")) {
                                try {
                                    const data = JSON.parse(buffer.slice(6));

                                    if (
                                        data.ai_message &&
                                        data.ai_message !== "" &&
                                        (!seenEmptyMessage ||
                                            data.ai_message.length <= accumulatedMessage.length * 0.9)
                                    ) {
                                        let cleanMessage = data.ai_message;
                                        if (
                                            typeof cleanMessage === "string" &&
                                            cleanMessage.startsWith(`${config.chatbotName}:`)
                                        ) {
                                            cleanMessage = cleanMessage
                                                .split(`${config.chatbotName}:`)[1]
                                                .replace(/^\s+|\s+$/g, "")
                                                .replace(/^[\s\uFEFF\xA0]+/, "")
                                                .trimLeft();
                                        }

                                        accumulatedMessage += cleanMessage;

                                        try {
                                            if (contentDiv) {
                                                contentDiv.innerHTML =
                                                    formatMessage(accumulatedMessage);
                                                scrollToBottom();
                                            }
                                        } catch (uiError) {
                                            console.error("Final UI update error:", uiError);
                                        }
                                    }
                                } catch (e) {
                                    console.error("Final buffer parse error:", e);
                                }
                            }

                            // Save to history if we have content
                            if (accumulatedMessage.length > 0) {
                                try {
                                    const formattedMessage = formatMessage(accumulatedMessage);
                                    if (contentDiv) {
                                        contentDiv.innerHTML = formattedMessage;
                                    }

                                    if (messageDiv) {
                                        const time =
                                            messageDiv.querySelector(".pai-chat-message-time")
                                                ?.textContent || getCurrentTime();

                                        if (config.saveHistory) {
                                            chatHistory.push({
                                                type: "ai",
                                                content: formattedMessage,
                                                time: time,
                                            });
                                            saveChatHistory();
                                        }
                                    }
                                } catch (historyError) {
                                    console.error("History save error:", historyError);
                                }
                            }

                            // Always return what we've got, even if it's incomplete
                            return accumulatedMessage;
                        } catch (finalError) {
                            console.error("Fatal stream error:", finalError);

                            if (!accumulatedMessage.length && contentDiv) {
                                contentDiv.innerHTML = "Error processing message stream.";
                            }

                            return accumulatedMessage || "";
                        } finally {
                            // Clean up to prevent memory leaks
                            try {
                                if (
                                    reader &&
                                    typeof reader.cancel === "function" &&
                                    isActiveRequest
                                ) {
                                    reader
                                        .cancel()
                                        .catch((e) => console.error("Reader cancel error:", e));
                                }
                            } catch (cleanupError) {
                                console.error("Stream cleanup error:", cleanupError);
                            }
                        }
                    },
                    // Expose cancel method
                    cancel: cancelRequest,
                };
            }

            // Auto-resize the input field as user types
            function resizeInput() {
                if (!config.autoResize) return;

                // Store current scroll position and caret position
                const scrollTop = chatInput.scrollTop;
                const caretPosition = chatInput.selectionStart;

                // Reset height to auto to measure content height
                chatInput.style.height = "auto";

                // Calculate minimum height that ensures first line is fully visible (including padding)
                const lineHeight = parseInt(
                    window.getComputedStyle(chatInput).lineHeight
                );
                const minVisibleHeight = lineHeight + 24; // 24px accounts for top and bottom padding

                // Calculate new height (constrained between minimum visible height and max height)
                const newHeight = Math.min(
                    Math.max(chatInput.scrollHeight, minVisibleHeight),
                    config.maxInputHeight
                );

                // Apply the new height
                chatInput.style.height = newHeight + "px";

                // Only show scrollbar when content exceeds max height
                if (chatInput.scrollHeight <= config.maxInputHeight) {
                    chatInput.style.overflowY = "hidden";
                } else {
                    chatInput.style.overflowY = "auto";

                    // Ensure the first line is visible when scrollbar appears
                    if (scrollTop < lineHeight) {
                        // If we're at the top, keep at top
                        chatInput.scrollTop = 0;
                    } else if (
                        scrollTop >=
                        chatInput.scrollHeight - config.maxInputHeight - 20
                    ) {
                        // If we're at the bottom, scroll to bottom
                        chatInput.scrollTop = chatInput.scrollHeight;
                    } else {
                        // Otherwise maintain scroll position
                        chatInput.scrollTop = scrollTop;
                    }
                }

                // Restore caret position after resize
                chatInput.setSelectionRange(caretPosition, caretPosition);
            }
            // Event Listeners
            chatInitiator.addEventListener("click", function () {
                this.style.display = "none";
                chatWindow.style.display = "flex";

                if (!userEmail && config.requireIntake) {
                    emailOverlay.style.display = "flex";
                } else {
                    // Display chat history if available and not empty
                    if (config.saveHistory && chatHistory && chatHistory.length > 0) {
                        displayChatHistory();
                        initialMessageSent = true; // Mark as sent so we don't show welcome again
                    } else if (!initialMessageSent) {
                        displayAIMessage(
                            config.initialQuestion ||
                            `Hi, I'm ${config.chatbotName}, how can I help you?`
                        );
                        initialMessageSent = true;
                    }
                }
            });

            expandedMessageIcon.addEventListener("click", function () {
                this.classList.add("hidden");

                setTimeout(() => {
                    this.style.display = "none";
                    chatWindow.style.display = "flex";

                    if (!userEmail && config.requireIntake) {
                        emailOverlay.style.display = "flex";
                    } else {
                        // Display chat history if available
                        if (config.saveHistory && chatHistory.length > 0) {
                            displayChatHistory();
                        } else if (!initialMessageSent) {
                            displayAIMessage(
                                config.initialQuestion ||
                                `Hi, I'm ${config.chatbotName}, how can I help you?`
                            );
                            initialMessageSent = true;
                        }
                    }
                }, 300);
            });

            messageIcon.addEventListener("click", function (event) {
                event.stopPropagation();
                chatInitiator.style.display = "none";
                chatWindow.style.display = "flex";

                if (!userEmail && config.requireIntake) {
                    emailOverlay.style.display = "flex";
                } else {
                    // Display chat history if available
                    if (config.saveHistory && chatHistory.length > 0) {
                        displayChatHistory();
                    } else if (!initialMessageSent) {
                        displayAIMessage(
                            config.initialQuestion ||
                            `Hi, I'm ${config.chatbotName}, how can I help you?`
                        );
                        initialMessageSent = true;
                    }
                }
            });

            mainChatClose.addEventListener("click", () => {
                chatWindow.style.display = "none";
                showMessageIcon();
                // Cancel any pending API requests when closing chat
                if (controller) {
                    controller.abort();
                    controller = null;
                }
            });

            emailFormClose.addEventListener("click", () => {
                chatWindow.style.display = "none";
                showMessageIcon();
            });

            initiatorCloseButton.addEventListener("click", function (event) {
                event.stopPropagation();
                this.style.display = "none";

                const avatarWrapper = chatInitiator.querySelector(
                    ".pai-chat-avatar-wrapper"
                );
                const chatBubble = chatInitiator.querySelector(".pai-chat-bubble");

                avatarWrapper.style.opacity = "0";
                chatBubble.style.opacity = "0";

                setTimeout(() => {
                    chatInitiator.style.display = "none";
                    showMessageIcon();
                }, 300);
            });

            fullscreenToggle.addEventListener("click", function () {
                chatWindow.classList.toggle("fullscreen");
                const isFullscreen = chatWindow.classList.contains("fullscreen");
                fullscreenToggle.innerHTML = isFullscreen
                    ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>';

                scrollToBottom();
            });

            submitButton.addEventListener("click", async function () {
                // Prevent multiple clicks
                if (this.disabled) return;
                this.disabled = true;

                const validations = {
                    firstName: validateInput(
                        inputs.firstName,
                        errors.firstName,
                        (value) => value.length > 0
                    ),
                    lastName: validateInput(
                        inputs.lastName,
                        errors.lastName,
                        (value) => value.length > 0
                    ),
                    email: validateInput(inputs.email, errors.email, isValidEmail),
                    phone:
                        inputs.phone.value.trim() === "" ||
                        validateInput(inputs.phone, errors.phone, isValidPhone),
                };

                if (Object.values(validations).every((v) => v)) {
                    // Add loading indicator to button
                    this.innerHTML =
                        '<span class="pai-loading-spinner"></span>Submitting...';

                    userData = {
                        firstName: inputs.firstName.value.trim(),
                        lastName: inputs.lastName.value.trim(),
                        email: inputs.email.value.trim(),
                        phone: inputs.phone.value.trim(),
                    };

                    userEmail = userData.email;
                    sessionId = userData.email;

                    try {
                        localStorage.setItem("pai-chat-session", userData.email);

                        // Hide overlay and enable chat input immediately
                        emailOverlay.style.display = "none";
                        chatInput.disabled = false;
                        sendButton.disabled = false;

                        // Show initial message immediately
                        initialMessageSent = true;
                        displayAIMessage(
                            config.initialQuestion ||
                            `Hi ${userData.firstName}, I'm ${config.chatbotName}, how can I help you?`
                        );

                        // Send data to Personal AI in parallel
                        await Promise.all([
                                fetch(config.proxyUrl, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    Text: `User Information:\nFirst Name: ${userData.firstName}\nLast Name: ${userData.lastName}\nEmail: ${userData.email}\nPhone: ${userData.phone}`,
                                    UserName: userData.email,
                                    SourceName: "WebChat",
                                    SessionId: userData.email,
                                    is_draft: false,
                                }),
                            }),
                                fetch(config.proxyUrl, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    Text: "START_CHAT",
                                    UserName: userData.email,
                                    SourceName: "WebChat",
                                    SessionId: userData.email,
                                    is_draft: false,
                                }),
                            }),
                        ]);

                        // Send data to webhook if enabled and URL is provided
                        if (config.enableWebhook && config.webhookUrl) {
                            try {
                                // Create URL with parameters for GET request
                                const params = new URLSearchParams({
                                    firstName: userData.firstName,
                                    lastName: userData.lastName,
                                    email: userData.email,
                                    phone: userData.phone || "",
                                    timestamp: new Date().toISOString(),
                                    source: "Chatbot Form",
                                    domainName: config.domainName,
                                });

                                // Append parameters to URL and make GET request
                                const webhookUrlWithParams = `${config.webhookUrl
                                    }?${params.toString()}`;

                                await fetch(webhookUrlWithParams, {
                                    method: "GET",
                                    mode: "no-cors",
                                    // No body for GET requests
                                });
                            } catch (webhookError) {
                                console.error("Webhook error:", webhookError);
                                // Continue execution even if webhook fails
                            }
                        }
                    } catch (error) {
                        console.error("Error during user registration:", error);
                        // Show error message but keep the chat open
                        displayAIMessage(
                            "I encountered an issue with your registration, but we can continue chatting. You may need to provide your information again next time."
                        );
                    } finally {
                        // Enable the button again
                        this.disabled = false;
                        this.innerHTML = "Start Chat";
                    }
                } else {
                    // Enable the button if validation fails
                    this.disabled = false;
                }
            });

            // Debounced input handler for better performance
            const debouncedResize = debounce(resizeInput, config.debounceDelay);

            chatInput.addEventListener("input", function () {
                // Check if content exceeds visible area and handle scrolling
                if (this.scrollHeight > this.clientHeight) {
                    this.style.overflowY = "auto";
                    this.scrollTop = this.scrollHeight;
                } else {
                    this.style.overflowY = "hidden";
                }
            });

            chatInput.addEventListener("keypress", function (event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    handleMessage(this.value);
                }
            });

            sendButton.addEventListener("click", function () {
                handleMessage(chatInput.value);
            });

            document.addEventListener("keydown", function (event) {
                if (event.key === "Escape" && chatWindow.style.display === "flex") {
                    chatWindow.style.display = "none";
                    showMessageIcon();

                    // Cancel any pending API requests when closing chat
                    if (controller) {
                        controller.abort();
                        controller = null;
                    }
                }
            });

            window.addEventListener("resize", function () {
                // Only trigger mobile view if it's actually a mobile device
                const isMobileDevice =
                    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
                        navigator.userAgent
                    );

                if (
                    isMobileDevice &&
                    window.innerWidth <= 480 &&
                    chatWindow.style.display === "flex"
                ) {
                    // Apply mobile fullscreen styling
                    chatWindow.style.width = "100%";
                    chatWindow.style.height = "100%";
                    chatWindow.style.maxHeight = "100%";
                    chatWindow.style.top = "0";
                    chatWindow.style.right = "0";
                    chatWindow.style.bottom = "0";
                    chatWindow.style.left = "0";
                    chatWindow.style.borderRadius = "0";

                    // Hide fullscreen toggle on mobile
                    if (fullscreenToggle) {
                        fullscreenToggle.style.display = "none";
                    }

                    // Adjust message container height
                    if (chatMessages) {
                        chatMessages.style.height = "calc(100% - 160px)";
                    }
                } else if (!chatWindow.classList.contains("fullscreen")) {
                    // Reset to default size if not in fullscreen mode and window is resized
                    chatWindow.style.width = "380px";
                    chatWindow.style.height = "600px";
                    chatWindow.style.maxHeight = "calc(100vh - 100px)";
                    chatWindow.style.borderRadius = "20px";

                    // Reset position to configured position
                    switch (config.initiatorPosition) {
                        case "top-left":
                            chatWindow.style.top = "20px";
                            chatWindow.style.left = "20px";
                            chatWindow.style.right = "auto";
                            chatWindow.style.bottom = "auto";
                            break;
                        case "top-right":
                            chatWindow.style.top = "20px";
                            chatWindow.style.right = "20px";
                            chatWindow.style.left = "auto";
                            chatWindow.style.bottom = "auto";
                            break;
                        case "bottom-left":
                            chatWindow.style.bottom = "20px";
                            chatWindow.style.left = "20px";
                            chatWindow.style.right = "auto";
                            chatWindow.style.top = "auto";
                            break;
                        case "bottom-right":
                        default:
                            chatWindow.style.bottom = "20px";
                            chatWindow.style.right = "20px";
                            chatWindow.style.left = "auto";
                            chatWindow.style.top = "auto";
                            break;
                    }

                    // Show fullscreen toggle
                    if (fullscreenToggle) {
                        fullscreenToggle.style.display = "flex";
                    }

                    // Reset message container height
                    if (chatMessages) {
                        chatMessages.style.height = "calc(100% - 180px)";
                    }
                }
            });

            // For accessibility - allow tab navigation
            document
                .querySelectorAll(
                    ".pai-chat-input, .pai-chat-send-inline, .pai-intake-input, .pai-intake-submit"
                )
                .forEach((element) => {
                    element.addEventListener("focus", function () {
                        this.style.outline = `2px solid ${config.sendButtonColor}`;
                    });

                    element.addEventListener("blur", function () {
                        this.style.outline = "none";
                    });
                });

            // Add ability to cancel API requests on page unload
            window.addEventListener("beforeunload", function () {
                if (controller) {
                    controller.abort();
                }
            });

            // Initialize the chat widget with error handling
            try {
                typeInitialMessage();
            } catch (e) {
                console.error("Error initializing chat widget:", e);
                // Fallback to simple text if typing animation fails
                if (aiInitialMessage) {
                    aiInitialMessage.textContent = config.initialMessage;
                    messageIcon.classList.add("fade-in");
                    initiatorCloseButton.classList.add("fade-in");
                }
            }
        };
    })();
</script>
